<!DOCTYPE html>
<!--
  Minimal Mistakes Jekyll Theme 4.27.3 by Michael Rose
  Copyright 2013-2025 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
--><html lang="en" class="no-js">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Consumers/Producers Migrations Strategies - Felipe Nipo</title>
<meta name="description" content="Introduction Migrating systems brings an entirely different set of challenges: doing it without downtime, keeping data consistency, and ensuring a seamless experience for customers in production.">


  <meta name="author" content="Felipe Nipo">
  
  <meta property="article:author" content="Felipe Nipo">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="Felipe Nipo">
<meta property="og:title" content="Consumers/Producers Migrations Strategies">
<meta property="og:url" content="https://fnipo.github.io/distributed-systems/2025/09/16/consumers-producers-migrations-strategies.html">


  <meta property="og:description" content="Introduction Migrating systems brings an entirely different set of challenges: doing it without downtime, keeping data consistency, and ensuring a seamless experience for customers in production.">



  <meta property="og:image" content="https://fnipo.github.io/assets/consumers-producers-migrations-strategies.jpg">





  <meta property="article:published_time" content="2025-09-16T00:00:00+00:00">






<link rel="canonical" href="https://fnipo.github.io/distributed-systems/2025/09/16/consumers-producers-migrations-strategies.html">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap" rel="stylesheet">
  </head>

  <body class="layout--single wide" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Felipe Nipo
          
        </a>
        <ul class="visible-links">
          <!-- DISABLED MASTHEAD -->
          <!--<li class="masthead__menu-item">
              <a
                href="https://mmistakes.github.io/minimal-mistakes/docs/quick-start-guide/"
                
                
              >Quick-Start Guide</a>
            </li>-->
        </ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://fnipo.github.io/">
        <img src="/assets/bio-photo.jpg" alt="Felipe Nipo" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://fnipo.github.io/" itemprop="url">Felipe Nipo</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Software Engineer</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Dublin, Ireland</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/felipenipo" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/felipenipo/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/fnipo" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Consumers/Producers Migrations Strategies">
    <meta itemprop="description" content="IntroductionMigrating systems brings an entirely different set of challenges: doing it without downtime, keeping data consistency, and ensuring a seamless experience for customers in production.">
    <meta itemprop="datePublished" content="2025-09-16T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://fnipo.github.io/distributed-systems/2025/09/16/consumers-producers-migrations-strategies.html" itemprop="url">Consumers/Producers Migrations Strategies
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <h1 id="introduction">Introduction</h1>
<p>Migrating systems brings an entirely different set of challenges: doing it without downtime, keeping data consistency, and ensuring a seamless experience for customers in production.</p>

<p>This is often where the value of solid engineering practices becomes visible. Reliable testing builds confidence in avoiding regressions, while idempotency can be a great facilitator for a smooth migration.</p>

<p>In this article, I’ll cover common messaging-related migration scenarios that involve Kafka consumers and producers, along with their caveats.</p>

<h1 id="scenario-1-the-happy-path">Scenario 1: The Happy Path</h1>
<p>The happy path is when a contract changes in a backward-compatible way. In this case, you don’t need to declare a new version of the contract, and the same topic can continue to be used.</p>

<p>Because the change is backward-compatible, existing consumers won’t break when handling the new contract, and they can be upgraded at their own pace.</p>

<p>Common backward-compatible changes include:</p>
<ul>
  <li>Adding a new field: outdated consumers simply ignore it.</li>
  <li>Adding new values to an enum: outdated consumers ignore them or fall back to defaults.</li>
  <li>Turning optional fields mandatory: outdated consumers are already coded to handle the field whether it has a value or is null.</li>
</ul>

<p><img class="plantuml align-center" src="http://www.plantuml.com/plantuml/svg/~h407374617274756d6c0a407374617274756d6c0a0a217468656d6520626c7565677261790a736b696e706172616d2051756575654261636b67726f756e64436f6c6f7220234646464646460a736b696e706172616d205175657565426f72646572436f6c6f7220236163616361630a736b696e706172616d205175657565466f6e74436f6c6f7220233561356135610a736b696e706172616d204e6f74654261636b67726f756e64436f6c6f7220436f726e73696c6b0a736b696e706172616d204e6f7465426f72646572436f6c6f7220236163616361630a736b696e706172616d204e6f7465466f6e74436f6c6f7220233561356135610a736b696e706172616d206261636b67726f756e64436f6c6f7220234646464646460a736b696e706172616d204172726f77436f6c6f7220477261790a736b696e706172616d206c6567656e64466f6e7453697a6520370a6c65667420746f20726967687420646972656374696f6e0a0a6c6567656e6420746f700af09f9fa6204e657720436f6d706f6e656e740af09f9fa52052656d6f76656420436f6d706f6e656e740a656e646c6567656e640a0a72656374616e676c65202246696e616c2053746174652220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f64205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f64205b0a20202020202020202a2a546f7069632a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76325f64205b0a20202020202020202a2a436f6e73756d65722076322a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f64202020202d2d3e2020202020746f7069635f6420202020202020202020203a202020202076310a20202020746f7069635f64202020202020202d2d3e2020202020636f6e73756d65725f76325f6420202020203a20202020207631202020200a7d0a0a72656374616e676c65202250686173652032202d20436f6e73756d65722069732055706772616465642220236c696e653a47726179207b202020200a2020202072656374616e676c652070726f64756365725f63205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f63205b0a20202020202020202a2a546f7069632a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76325f6320236c696e653a626c7565205b0a20202020202020202a2a436f6e73756d65722076322a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76315f6320236c696e652e6461736865643b6c696e653a726564205b0a20202020202020202a2a436f6e73756d65722076312a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f63202020202d2d3e202020202020202020202020746f7069635f632020202020202020202020203a202020202076310a20202020746f7069635f63202020202020202e5b237265645d2d3e202020202020636f6e73756d65725f76315f632020202020203a202020202076310a20202020746f7069635f63202020202020202d5b23626c75655d2d3e2020202020636f6e73756d65725f76325f632020202020203a202020202076310a7d0a0a72656374616e676c65202250686173652031202d20436f6e747261637420697320557064617465642220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f62205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f62205b0a20202020202020202a2a546f7069632a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76315f62205b0a20202020202020202a2a436f6e73756d65722076312a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f6220202020202020202d5b23626c75655d2d3e20202020746f7069635f622020202020202020202020203a2020202020202076310a20202020746f7069635f6220202020202020202020202d5b23626c75655d2d3e20202020636f6e73756d65725f76315f622020202020203a2020202020202076310a7d0a0a72656374616e676c652022496e697469616c2053746174652220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f61205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f61205b0a20202020202020202a2a546f7069632a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76315f61205b0a20202020202020202a2a436f6e73756d65722076312a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f6120202020202020202d2d3e20202020202020746f7069635f612020202020202020203a2020202020202076310a20202020746f7069635f6120202020202020202020202d2d3e20202020202020636f6e73756d65725f76315f612020203a2020202020202076310a7d0a0a40656e64756d6c0a40656e64756d6c"></p>

<p>In these cases, consumers aren’t required to upgrade immediately. For example, a service might not care about the new field and can continue ignoring it.</p>

<p>When consumers do upgrade, reusing the same consumer group ID ensures they resume exactly where the previous consumer left off. Kafka’s consumer group metadata tracks the last consumed offset, preventing both reprocessing and message loss.</p>

<h1 id="scenario-2-breaking-changes">Scenario 2: Breaking Changes</h1>
<p>Sometimes breaking changes to a contract are unavoidable. In this scenario, a new version of the contract must be introduced.</p>

<p>Typical breaking changes include:</p>
<ul>
  <li>Deleting a mandatory field: outdated consumers fail to deserialize.</li>
  <li>Renaming a mandatory field: effectively the same as deleting the old one and adding a new one.</li>
  <li>Changing field types: outdated consumers deserialize incorrectly.</li>
</ul>

<h3 id="producing-both-versions">Producing Both Versions</h3>

<p>A common approach is to apply the <a href="https://martinfowler.com/bliki/ParallelChange.html">Parallel Change Pattern</a>, making producers emit both the old and new contracts to the same topic during a migration period.</p>

<p>For example, a producer may publish both versions of a message, <code class="language-plaintext highlighter-rouge">OrderCreatedV1</code> and <code class="language-plaintext highlighter-rouge">OrderCreatedV2</code>, to an <code class="language-plaintext highlighter-rouge">order-created</code> topic. Old consumers continue processing <code class="language-plaintext highlighter-rouge">OrderCreatedV1</code> messages while consumers are incrementally upgraded to handle <code class="language-plaintext highlighter-rouge">OrderCreatedV2</code> messages.</p>

<p>Eventually the producer switches to publishing only <code class="language-plaintext highlighter-rouge">OrderCreatedV2</code> messages, once all consumers are upgraded.</p>

<p><img class="plantuml align-center" src="http://www.plantuml.com/plantuml/svg/~h407374617274756d6c0a407374617274756d6c0a0a217468656d6520626c7565677261790a736b696e706172616d2051756575654261636b67726f756e64436f6c6f7220234646464646460a736b696e706172616d205175657565426f72646572436f6c6f7220236163616361630a736b696e706172616d205175657565466f6e74436f6c6f7220233561356135610a736b696e706172616d204e6f74654261636b67726f756e64436f6c6f7220436f726e73696c6b0a736b696e706172616d204e6f7465426f72646572436f6c6f7220236163616361630a736b696e706172616d204e6f7465466f6e74436f6c6f7220233561356135610a736b696e706172616d206261636b67726f756e64436f6c6f7220234646464646460a736b696e706172616d204172726f77436f6c6f7220477261790a736b696e706172616d206c6567656e64466f6e7453697a6520370a6c65667420746f20726967687420646972656374696f6e0a0a6c6567656e6420746f700af09f9fa6204e657720436f6d706f6e656e740af09f9fa52052656d6f76656420436f6d706f6e656e740a656e646c6567656e640a0a72656374616e676c65202246696e616c2053746174652220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f65205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f65205b0a20202020202020202a2a546f7069632a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76325f65205b0a20202020202020202a2a436f6e73756d65722076322a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f65202020202d2d3e2020202020746f7069635f6520202020202020202020203a202020202076320a20202020746f7069635f65202020202020202d2d3e2020202020636f6e73756d65725f76325f6520202020203a20202020207632202020200a7d0a0a72656374616e676c65202250686173652033202d20486f7573656b656570696e672220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f64205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f64205b0a20202020202020202a2a546f7069632a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76325f64205b0a20202020202020202a2a436f6e73756d65722076322a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f6420202020202020202d2d3e2020202020202020202020746f7069635f642020202020202020202020203a2020202020202076320a2020202070726f64756365725f6420202020202020202e5b237265645d2d3e2020202020746f7069635f642020202020202020202020203a2020202020202076310a20202020746f7069635f6420202020202020202020202d2d3e2020202020202020202020636f6e73756d65725f76325f642020202020203a2020202020202076320a20202020746f7069635f6420202020202020202020202e5b237265645d2d3e2020202020636f6e73756d65725f76325f642020202020203a2020202020202076310a202020200a7d0a0a72656374616e676c65202250686173652032202d20436f6e73756d65722069732055706772616465642220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f63205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f63205b0a20202020202020202a2a546f7069632a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76325f6320236c696e653a626c7565205b0a20202020202020202a2a436f6e73756d65722076322a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76315f6320236c696e652e6461736865643b6c696e653a726564205b0a20202020202020202a2a436f6e73756d65722076312a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f6320202020202020202d2d3e2020202020202020202020746f7069635f632020202020202020202020203a2020202020202076320a2020202070726f64756365725f6320202020202020202d2d3e2020202020202020202020746f7069635f632020202020202020202020203a2020202020202076310a20202020746f7069635f6320202020202020202020202e5b237265645d2d3e2020202020636f6e73756d65725f76315f632020202020203a2020202020202076320a20202020746f7069635f6320202020202020202020202e5b237265645d2d3e2020202020636f6e73756d65725f76315f632020202020203a2020202020202076310a20202020746f7069635f6320202020202020202020202d5b23626c75655d2d3e20202020636f6e73756d65725f76325f632020202020203a2020202020202076320a20202020746f7069635f6320202020202020202020202d5b23626c75655d2d3e20202020636f6e73756d65725f76325f632020202020203a2020202020202076310a7d0a0a72656374616e676c65202250686173652031202d20436f6e747261637420763220697320496e74726f64756365642220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f62205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f62205b0a20202020202020202a2a546f7069632a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76315f62205b0a20202020202020202a2a436f6e73756d65722076312a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f6220202020202020202d5b23626c75655d2d3e20202020746f7069635f622020202020202020202020203a2020202020202076320a2020202070726f64756365725f6220202020202020202d2d3e2020202020202020202020746f7069635f622020202020202020202020203a2020202020202076310a20202020746f7069635f6220202020202020202020202d5b23626c75655d2d3e20202020636f6e73756d65725f76315f622020202020203a2020202020202076320a20202020746f7069635f6220202020202020202020202d2d3e2020202020202020202020636f6e73756d65725f76315f622020202020203a2020202020202076310a7d0a0a72656374616e676c652022496e697469616c2053746174652220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f61205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f61205b0a20202020202020202a2a546f7069632a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76315f61205b0a20202020202020202a2a436f6e73756d65722076312a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f6120202020202020202d2d3e20202020202020746f7069635f612020202020202020203a2020202020202076310a20202020746f7069635f6120202020202020202020202d2d3e20202020202020636f6e73756d65725f76315f612020203a2020202020202076310a7d0a0a40656e64756d6c0a40656e64756d6c"></p>

<p>When the new consumer reuses the same consumer group, old and new consumers operate as <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/competing-consumers">Competing Consumers</a>.
For each pair of <code class="language-plaintext highlighter-rouge">v1</code> and <code class="language-plaintext highlighter-rouge">v2</code> messages, both messages share the same partition key, which Kafka ensures they are placed in the same partition and processed by the same consumer instance.</p>

<p>This guarantees that only the supported contract version of the assigned consumer instance is processed, so idempotency is not required for deduplication.</p>

<h3 id="️-caveat-replaying">⚠️ Caveat: Replaying</h3>

<p>Replaying such a topic in the future requires consumers to be able to handle all historic contract versions existing within the topic. And to do so idempotently, to avoid redundant processing of different versions of the same message.</p>

<h3 id="️-caveat-dual-writes">⚠️ Caveat: Dual Writes</h3>

<p>Read more in the <a href="https://felipenipo.com/distributed-systems/2022/06/17/solving-dual-writes-with-cdc-and-the-outbox-pattern.html">Dual Writes</a> post.</p>

<p>Consider this scenario:</p>
<ol>
  <li>One version may be produced successfully while the other fails.</li>
  <li>Retrying it can cause the previous successfully produced message version to be produced again to the topic.</li>
  <li>Exactly-once guarantees may be compromised unless consumers are idempotent.</li>
</ol>

<p>When dual writes become an issue, the alternative is a Producer Hard-switch strategy.</p>

<h3 id="extra-challenge-introducing-a-new-consumer-group">Extra Challenge: Introducing a New Consumer Group</h3>

<p>If a new consumer group is introduced, the system behaves as <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/publisher-subscriber">Publisher-Subscriber</a>.
In this mode, non-idempotent consumers will redundantly process both versions of messages. If exactly-once guarantees are required, consider either a Consumer Hard-switch or a Producer Hard-switch.</p>

<p>Also be mindful of deployment strategies like <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/update/update-intro">Kubernetes Rolling Updates</a>, which can temporarily run old and new consumers in parallel, reproducing this scenario.</p>

<h1 id="scenario-3-a-new-topic-has-to-be-introduced">Scenario 3: A New Topic Has to Be Introduced</h1>

<p>Sometimes it isn’t possible to keep multiple contract versions in the same topic, and a new topic must be created, bringing versioning to topics.</p>

<p>This is necessary when:</p>
<ul>
  <li>The Kafka Schema Registry subject naming strategy disallows multiple contracts per topic.</li>
  <li>Consumers are external, unclear, or not under your control (e.g., third-party or customer integrations), making it hard to ensure they can handle multiple contract versions.</li>
  <li>The new schema represents a fundamentally different model, and the old topic is no longer suitable.</li>
  <li>The partition key changes. While its technically possible to change a topic’s partition key, it will lead to messages being processed out-of-order, as previously produced messages won’t be re-partitioned. A new topic is usually recommended.</li>
  <li>The partition count changes. Again, this is technically possible, but unless your system can tolerate out-of-order messages, a new topic should be created.</li>
</ul>

<p>In these cases, versioning applies to topics themselves (e.g., <code class="language-plaintext highlighter-rouge">order-created</code> vs <code class="language-plaintext highlighter-rouge">order-created-v2</code>), and upgrading Consumers require a multi-topic migration plan.</p>

<h3 id="when-consumers-are-idempotent">When Consumers are Idempotent</h3>

<p><img class="plantuml align-center" src="http://www.plantuml.com/plantuml/svg/~h407374617274756d6c0a407374617274756d6c0a0a217468656d6520626c7565677261790a736b696e706172616d2051756575654261636b67726f756e64436f6c6f7220234646464646460a736b696e706172616d205175657565426f72646572436f6c6f7220236163616361630a736b696e706172616d205175657565466f6e74436f6c6f7220233561356135610a736b696e706172616d204e6f74654261636b67726f756e64436f6c6f7220436f726e73696c6b0a736b696e706172616d204e6f7465426f72646572436f6c6f7220236163616361630a736b696e706172616d204e6f7465466f6e74436f6c6f7220233561356135610a736b696e706172616d206261636b67726f756e64436f6c6f7220234646464646460a736b696e706172616d204172726f77436f6c6f7220477261790a736b696e706172616d206c6567656e64466f6e7453697a6520370a6c65667420746f20726967687420646972656374696f6e0a0a6c6567656e6420746f700af09f9fa6204e657720436f6d706f6e656e740af09f9fa52052656d6f76656420436f6d706f6e656e740a656e646c6567656e640a0a72656374616e676c65202246696e616c2053746174652220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f65205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f65205b0a20202020202020202a2a546f7069632076322a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76325f65205b0a20202020202020202a2a436f6e73756d65722076322a2a0a20202020202020202867726f75703a204132290a202020205d0a0a2020202070726f64756365725f65202020202d2d3e2020202020746f7069635f6520202020202020202020203a202020202076320a20202020746f7069635f65202020202020202d2d3e2020202020636f6e73756d65725f76325f6520202020203a20202020207632202020200a7d0a0a72656374616e676c65202250686173652033202d20486f7573656b656570696e672220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f64205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f76325f64205b0a20202020202020202a2a546f7069632076322a2a0a202020205d0a0a20202020717565756520746f7069635f76315f6420236c696e652e6461736865643b6c696e653a726564205b0a20202020202020202a2a546f7069632076312a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76325f64205b0a20202020202020202a2a436f6e73756d65722076322a2a0a20202020202020202867726f75703a204132290a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76315f6420236c696e652e6461736865643b6c696e653a726564205b0a20202020202020202a2a436f6e73756d65722076312a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f6420202020202020202d2d3e2020202020202020202020746f7069635f76325f642020202020202020203a2020202020202076320a2020202070726f64756365725f6420202020202020202e5b237265645d2d3e2020202020746f7069635f76315f642020202020202020203a2020202020202076310a20202020746f7069635f76325f6420202020202020202d2d3e2020202020202020202020636f6e73756d65725f76325f642020202020203a2020202020202076320a20202020746f7069635f76315f6420202020202020202e5b237265645d2d3e2020202020636f6e73756d65725f76315f642020202020203a2020202020202076310a7d0a0a72656374616e676c65202250686173652032202d20436f6e73756d65722069732055706772616465642220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f63205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f76325f63205b0a20202020202020202a2a546f7069632076322a2a0a202020205d0a0a20202020717565756520746f7069635f76315f63205b0a20202020202020202a2a546f7069632076312a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76325f6320236c696e653a626c7565205b0a20202020202020202a2a436f6e73756d65722076322a2a0a20202020202020202867726f75703a204132290a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76315f63205b0a20202020202020202a2a436f6e73756d65722076312a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f6320202020202020202d2d3e2020202020202020202020746f7069635f76325f632020202020202020203a2020202020202076320a2020202070726f64756365725f6320202020202020202d2d3e2020202020202020202020746f7069635f76315f632020202020202020203a2020202020202076310a20202020746f7069635f76315f6320202020202020202d2d3e2020202020202020202020636f6e73756d65725f76315f632020202020203a2020202020202076310a20202020746f7069635f76325f6320202020202020202d5b23626c75655d2d3e20202020636f6e73756d65725f76325f632020202020203a2020202020202076320a7d0a0a72656374616e676c65202250686173652031202d20546f70696320763220697320496e74726f64756365642220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f62205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f76325f6220236c696e653a626c7565205b0a20202020202020202a2a546f7069632076322a2a0a202020205d0a0a20202020717565756520746f7069635f76315f62205b0a20202020202020202a2a546f7069632076312a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76315f62205b0a20202020202020202a2a436f6e73756d65722076312a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f6220202020202020202d5b23626c75655d2d3e20202020746f7069635f76325f622020202020202020202020203a2020202020202076320a2020202070726f64756365725f6220202020202020202d2d3e2020202020202020202020746f7069635f76315f622020202020202020202020203a2020202020202076310a20202020746f7069635f76315f6220202020202020202d2d3e2020202020202020202020636f6e73756d65725f76315f622020202020202020203a2020202020202076310a7d0a0a72656374616e676c652022496e697469616c2053746174652220236c696e653a47726179207b0a2020202072656374616e676c652070726f64756365725f61205b0a20202020202020202a2a50726f64756365722a2a0a202020205d0a0a20202020717565756520746f7069635f61205b0a20202020202020202a2a546f7069632a2a0a202020205d0a0a2020202072656374616e676c6520636f6e73756d65725f76315f61205b0a20202020202020202a2a436f6e73756d65722076312a2a0a20202020202020202867726f75703a2041290a202020205d0a0a2020202070726f64756365725f6120202020202020202d2d3e20202020202020746f7069635f612020202020202020203a2020202020202076310a20202020746f7069635f6120202020202020202020202d2d3e20202020202020636f6e73756d65725f76315f612020203a2020202020202076310a7d0a0a40656e64756d6c0a40656e64756d6c"></p>

<p>Idempotent consumers can consume from both topics simultaneously, using an idempotency key to deduplicate messages and enable a gradual migration.</p>

<p>Old consumers would still process messages from the old topic. And in the meanwhile, the new consumers will be already consuming from the new source.</p>

<p>This approach allows for dark launches to give confidence in the transition. For instance, the new consumer may run in parallel with feature flags to disable side effects, just logging outputs to compare side-by-side old vs. new flows.</p>

<p>Lastly, the old topic’s consumers can be removed as part of a housekeeping effort.
The steps for this typically looks like this:</p>
<ol>
  <li>Phase out the old topic’s producer so no new messages are added to the old topic.</li>
  <li>Wait until the old topic dries out and all messages are consumed.</li>
  <li>Remove the old topic’s consumers.</li>
</ol>

<h3 id="when-consumers-arent-idempotent">When Consumers Aren’t Idempotent</h3>

<p>Without idempotency, consumers must perform a hard switch. The challenge is ensuring the new consumer group starts processing from the equivalent offset of the old group, without reprocessing or skipping messages.</p>

<p>Read more in the Hard Switches post (coming soon…).</p>

<h1 id="rollbacks">Rollbacks</h1>

<p>Rollbacks are as complex as migrations themselves.</p>

<p>For example, if a <a href="https://felipenipo.com/distributed-systems/2025/09/16/consumers-producers-migrations-strategies.html#scenario-3-a-new-topic-has-to-be-introduced">Scenario 3</a> migration involves:</p>
<ol>
  <li>Switching producers to a new topic</li>
  <li>Switching consumers to the new topic</li>
</ol>

<p>Then a rollback requires the reverse:</p>
<ol>
  <li>Switching producers back to the old topic</li>
  <li>Switching consumers back to the old topic</li>
</ol>

<p>Delivery guarantees also apply in reverse. Before rolling consumers back, you may need to wait until the new topic is drained and all messages produced to it are processed, ensuring no loss.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Idempotency is a powerful tool for simplifying migrations, particularly for high-available systems.</p>

<p>It allows for parallel processing, safe retries, gradual migrations, and more resilient rollbacks. Without it, migrations may require hard-switches, which involves a risky choreography of producer and consumer switches, usually leading to downtimes.</p>

<p>If you’re designing a high-available system today, bake idempotency in from the start and your future self will thank you when migrations inevitably arrive.</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-09-16T00:00:00+00:00">September 16, 2025</time></p>

      </footer>

      <section class="page__share">
  <h4 class="page__share-title">Share on</h4>

  <a href="https://x.com/intent/tweet?text=Consumers%2FProducers+Migrations+Strategies%20https%3A%2F%2Ffnipo.github.io%2Fdistributed-systems%2F2025%2F09%2F16%2Fconsumers-producers-migrations-strategies.html" class="btn btn--x" aria-label="Share on X" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on X">
    <i class="fab fa-fw fa-x-twitter" aria-hidden="true"></i><span> X</span>
  </a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ffnipo.github.io%2Fdistributed-systems%2F2025%2F09%2F16%2Fconsumers-producers-migrations-strategies.html" class="btn btn--facebook" aria-label="Share on Facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook">
    <i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span>
  </a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://fnipo.github.io/distributed-systems/2025/09/16/consumers-producers-migrations-strategies.html" class="btn btn--linkedin" aria-label="Share on LinkedIn" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn">
    <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span>
  </a>

  <a href="https://bsky.app/intent/compose?text=Consumers%2FProducers+Migrations+Strategies%20https%3A%2F%2Ffnipo.github.io%2Fdistributed-systems%2F2025%2F09%2F16%2Fconsumers-producers-migrations-strategies.html" class="btn btn--bluesky" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Bluesky">
    <i class="fab fa-fw fa-bluesky" aria-hidden="true"></i><span> Bluesky</span>
  </a>
</section>


      
  <nav class="pagination">
    
      <a href="/software-engineering/2025/07/01/semantic-versioning-is-just-an-estimate.html" class="pagination--pager" title="Semantic Versioning is Just an Estimate">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
<form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div>
</div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        


<div class="page__footer-copyright">© 2025 <a href="https://fnipo.github.io">Felipe Nipo</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P9LR4DJVN7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-P9LR4DJVN7', { 'anonymize_ip': false});
</script>








  </body>
</html>
